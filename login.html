<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ูุฑูุฏ ุจู ุณุณุชู ูุฏุฑุช ููุชูุฑุณฺฉู</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link rel="stylesheet" href="./global.css">
</head>
<body class="h-screen flex items-center justify-center px-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #667eea 50%, #764ba2 75%, #667eea 100%);">
  <div class="card p-6 max-w-xs w-full shadow-lg rounded-xl mx-auto">
    <div class="text-center mb-5">
      <div class="motorcycle-icon mx-auto mb-3" style="background: linear-gradient(145deg, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.2) 100%); font-size: 2rem; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin: 0 auto;">
        ๐
      </div>
      <h1 class="text-2xl font-bold text-white">ูุฑูุฏ ุจู ุฏุงุดุจูุฑุฏ</h1>
      <p class="text-gray-300 mt-1 text-sm">ูุทูุงู ูุงู ฺฉุงุฑุจุฑ ู ุฑูุฒ ุนุจูุฑ ุฎูุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ</p>
    </div>
    <form id="login-form" onsubmit="handleLogin(event)">
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-semibold text-white mb-1.5">ูุงู ฺฉุงุฑุจุฑ</label>
          <input type="text" id="username" class="input-field text-gray-600" placeholder="ูุงู ฺฉุงุฑุจุฑ" required>
        </div>
        <div>
          <label class="block text-sm font-semibold text-white mb-1.5">ุฑูุฒ ุนุจูุฑ</label>
          <input type="password" id="password" class="input-field text-gray-600" placeholder="ุฑูุฒ ุนุจูุฑ" required>
        </div>
        <button type="submit" class="btn btn-success w-full">โ ูุฑูุฏ</button>
      </div>
    </form>
    <div id="login-error" class="mt-3 p-2 bg-red-100 border border-red-400 text-red-700 rounded text-xs hidden">ูุงู ฺฉุงุฑุจุฑ ุง ุฑูุฒ ุนุจูุฑ ุงุดุชุจุงู ุงุณุช</div>
  </div>
  <!-- FIX: ุงุถุงูู ฺฉุฑุฏู googlesheets.js (ูุทูุฆู ุดู ูุงู ุขูพููุฏ ุดุฏู) -->
  <script src="googlesheets.js"></script>
  <script>
    // FIX: ูุชุบุฑูุง global ุงุฒ index.js (ฺฉูพโุดุฏู ุจุฑุง ุณุงุฒฺฏุงุฑ)
    let allUsers = []; // ูุณุช ฺฉุงุฑุจุฑุงู global
    const usersStorageKey = 'userAccountsData'; // Key for localStorage

    // FIX: ฺฉูพ functions ูุงุฒู ุงุฒ index.js ุจุฑุง loadUsers ู sync
    function generateId() {
      return Date.now().toString() + Math.random().toString(36).substr(2, 9);
    }

    async function loadUsers() {
      try {
        const stored = localStorage.getItem(usersStorageKey);
        // FIX: ุจูุจูุฏ handling ุจุฑุง undefined/null ู parse error
        if (!stored) {
          console.log('No localStorage users found โ starting fresh');
          allUsers = [];
        } else {
          try {
            allUsers = JSON.parse(stored);
            console.log('Parsed local users successfully:', allUsers.length, 'users');
          } catch (parseError) {
            console.error('JSON parse error in localStorage โ clearing corrupted data:', parseError);
            allUsers = []; // fallback
            localStorage.removeItem(usersStorageKey); // ูพุงฺฉ ฺฉุฑุฏู corrupted
          }
        }
        // ุงฺฉุงูุช ูพุดโูุฑุถ admin ุงฺฏุฑ ูุฌูุฏ ูุฏุงุดุชู ุจุงุดู
        if (allUsers.length === 0) {
          const defaultAdmin = {
            __backendId: generateId(),
            fullName: 'ุดูุงุจ ุญูุฏ',
            username: 'shahab',
            password: 'em',
            role: 'admin'
          };
          allUsers.push(defaultAdmin);
          await saveUsers();
          console.log('Added default admin:', defaultAdmin);
        }
        // FIX: Sync with Google Sheets (ุงฺฏุฑ ููุฏ ุดุฏู)
        if (typeof syncUsersWithGoogleSheets === 'function') {
          console.log('Attempting GS sync...');
          const syncSuccess = await syncUsersWithGoogleSheets();
          if (syncSuccess) {
            console.log('GS sync successful โ users updated');
          } else {
            console.warn('GS sync failed โ using local users');
          }
        } else {
          console.warn('googlesheets.js not loaded โ skipping GS sync');
        }
        console.log('Final loaded users:', allUsers.map(u => ({username: u.username, role: u.role}))); // ุฏุจุงฺฏ ุงูู (ุจุฏูู password)
        return allUsers;
      } catch (error) {
        console.error('Critical error in loadUsers:', error);
        allUsers = []; // ultimate fallback
        return [];
      }
    }

    async function saveUsers(users) {
      try {
        localStorage.setItem(usersStorageKey, JSON.stringify(users));
        console.log('Users saved to localStorage');
      } catch (error) {
        console.error('Error saving users to localStorage:', error);
      }
    }

    // FIX: ฺฉูพ map functions ุงุฒ googlesheets.js
    function mapUserToGS(item) {
      return {
        'Unique ID': item.__backendId,
        'ูุงู ฺฉุงูู': item.fullName,
        'ูุงู ฺฉุงุฑุจุฑ': item.username,
        'ุฑูุฒ ุนุจูุฑ': item.password,
        'ููุด': item.role
      };
    }

    function mapGSToUser(record) {
      return {
        __backendId: record['Unique ID'],
        fullName: record['ูุงู ฺฉุงูู'],
        username: record['ูุงู ฺฉุงุฑุจุฑ'],
        password: record['ุฑูุฒ ุนุจูุฑ'],
        role: record['ููุด']
      };
    }

    // FIX: Sync function (ฺฉูพ ุงุฒ index.js)
    async function syncUsersWithGoogleSheets() {
      try {
        console.log('Calling GS for users...');
        const result = await callGoogleSheets('readAll', 'accounts');
        console.log('GS response:', result);
        if (result && result.success) {
          const gsUsers = result.data
            .map(mapGSToUser)
            .filter(user => user && user.__backendId); // ููุท ูุนุชุจุฑ
          // ุฌุงฺฏุฒู allUsers ุจุง GS (keep default admin)
          const defaultAdminExists = gsUsers.some(u => u.username === 'admin');
          if (!defaultAdminExists) {
            const defaultAdmin = {
              __backendId: generateId(),
              fullName: 'ุดูุงุจ ุญูุฏ',
              username: 'shahab',
              password: 'em',
              role: 'admin'
            };
            gsUsers.push(defaultAdmin);
          }
          allUsers = gsUsers;
          await saveUsers(allUsers);
          console.log('GS sync complete โ', gsUsers.length, 'users loaded');
          return true;
        }
        console.warn('GS readAll failed:', result?.error || 'Unknown');
        return false;
      } catch (error) {
        console.error('Sync error:', error);
        return false;
      }
    }

    // FIX: ุชุงุจุน showToast ุณุงุฏู
    function showToast(message, icon = 'โ') {
      console.log(`${icon} ${message}`);
      // ุจุฑุง UI toastุ alert ุณุงุฏู ุงุณุชูุงุฏู ฺฉู ุงฺฏุฑ ุจุฎูุง
      // alert(`${icon} ${message}`);
    }

    // FIX: handleLogin ุจูุจูุฏโุงูุชู
    async function handleLogin(event) {
      event.preventDefault();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      document.getElementById('login-error').classList.add('hidden'); // hide error

      if (!username || !password) {
        showToast('ูุทูุงู ูุฒุฑูู ู ุฑูุฒ ุนุจูุฑ ุฑุง ูุงุฑุฏ ฺฉูุฏ', 'โ๏ธ');
        return;
      }

      console.log('Login attempt for:', username);
      await loadUsers(); // sync/load

      const user = allUsers.find(u => u.username === username && u.password === password);
      console.log('Found user match:', !!user, user?.username); // ุฏุจุงฺฏ

      if (user) {
        // FIX: session ุฑู ุจุง try-catch set ฺฉู
        try {
          const session = {
            loggedIn: true, 
            fullName: user.fullName || 'ฺฉุงุฑุจุฑ ูุงุดูุงุณ', 
            username: user.username, 
            role: user.role
          };
          localStorage.setItem('session', JSON.stringify(session));
          console.log('Session set:', session);
          showToast('ูุงฺฏู ูููู! ุฏุฑ ุญุงู ุงูุชูุงู...', 'โ');
          setTimeout(() => window.location.href = 'index.html', 500); // delay ุจุฑุง ูุงฺฏ
        } catch (saveError) {
          console.error('Session save error:', saveError);
          showToast('ุฎุทุง ุฏุฑ ุฐุฎุฑู ุฌูุณู โ ุฏูุจุงุฑู ุชูุงุด ฺฉูุฏ', 'โ');
        }
      } else {
        document.getElementById('login-error').classList.remove('hidden');
        document.getElementById('password').value = '';
        document.getElementById('password').focus();
        showToast('ูุฒุฑูู ุง ุฑูุฒ ุนุจูุฑ ุงุดุชุจุงู ุงุณุช', 'โ');
      }
    }

    // ููฺฉูุณ ู init
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('Login page loaded');
      await loadUsers(); // initial load
      document.getElementById('username').focus();
    });
  </script>
</body>
</html>

